# 7D2DModLauncherA19

Repository for [7D2DModLauncher][1] to crawl for A19 versions

This repo is only of interest for other modders if they want
to use the same (hard-versioned) sub-module approach, which
this repository is the first one to utilize.

## Purpose of this repository

[7D2DLauncher][1] will download a [sqlite database][2] where available
mods are listed. That database is generated by a crawler that is run
and maintained by [SphereII][6].

### How 7D2DModLauncher crawler creates modlet database

The crawler will query various "urls" to gather the latest and finest
mods available. It starts with a list of entry "urls" curated by [SphereII][6],
and this repository is one of those entry "urls". In fact there are various
specific handlers for specific "url" types, like GitHub, GitLab, etc. The
crawler will try its best to detect all mods within a given "url", but it
can only do that up to a certain point. This documentation will heavily
concentrate on how the GitHub "handler" works and was patched.

### How regular (old) entry urls worked

The way most "entry" urls work today is by combining multiple mods into
one big git repository (as with [SphereIIs A19 mod repository][3]). This
allows the crawler to easily query the entry url once and discover all
available mods of one modder. The big advantage of doing it this way is
that once a modder has his entry "url" added (and being trusted so to
speak), he can add more mods without any maintenance needed, by adding
new mods to his "big-repo".

#### Downside of the current "big repo" approach

While the "big repo" approach eases maintenance, it introduces an issues
which lies in the core of git. A user who only wants to install a single
mod, doesn't want to download the complete "big repo" (and in case of a
git clone it would even include each and every version ever created).

##### Why do mod git repos grow so fast in size

Git was designed as a versioning tool for text files, and mods often contain
large binary files (like images or unity3d files). Git needs to be able to
restore each and every version ever committed (and referenced by any branch
or tag, if you do a `git gc`). Given the nature of binary files, it's not
even the fault of a bad implementation with git, it's just the nature of
possible diff/patch for binary files. In lame terms this might mean that
each change to your 3MB resource file in fact adds 3MB to your git folder.
So 10 commits can easily add to 30MB for your overall git repository size.

#### A little insight on how 7D2DModLauncher downloads modlets

It took me a little by surprise to learn that [7D2DModLauncher][1] downloads
modlets for GitHub via the [SVN protocol][7]. But on a second look it started
to make sense, since it is in fact one of the easiest ways to download
only a specific directory of a repository. But it has its own drawbacks,
but I will go into these details a bit later.

### Proper git approach (IMHO)

I've used git extensively in my professional and my open-source adventures
for many years, and when I started doing some modding for 7D2D I certainly
knew I want to have one git repo per mod. This worked out well with [DMT][4]
and my overall modding workflow, but was problematic once I wanted my mods
to be included in [7D2DModLauncher][1].

#### Mimicking a "big repo" with `git subtree`

When I first reached out to [SphereII][6] I didn't know crap about how any of this
works. So I was blindly just assuming things. Once I learned how the crawler
did things, I first came up with a solution that involves `git subtree`. It's
a fancy thing and it did actually work. It basically gives you a few commands
that lets you merge/cherry-pick commits from various other repositories into one.

Unfortunately this ultimately has the same issues as a true "big repo" (the
.git directory will contain the history of each and every module). This would
have probably been my solution if [SphereII][6] wouldn't have been so kind to
allow me to hack his crawler to support my solution.

#### Using `git submodules` for the "big repo"

In my approach I'm using submodules in the big-repo (the one you are seeing
here right now) to just reference the separate/original repo of each mod
(with a specific commit ID and therefore a specific `ModInfo.xml` with a
specific "version"). Beside being much leaner in terms of disk-space used,
this also has a few (IMO desireable) advantages.

#### Fixed 7D2DModLauncher release version

The (patched) crawler will detect submodules in the root-folder of the
entry "url". Since it is a submodule, it will have a specific commit id
attached, which in turn leads to a last updated timestamp (which is shown
in the [7D2DModLauncher][1] UI). Unfortunately [7D2DModLauncher][1] can't download
that specific commit ID, since that is not exposed via the SVN protocol.
But I found a way to link this to tags (which is IMO a nice approach).

#### Downloading specific version of a mod

As mentioned, SVN doesn't support the download of a specific directory
with a specific commit id (and git doesn't allow to just download a
specific directory of a specific commit id). But SVN allows to download
anything of a specific branch or tag. The patched crawler will check the
`ModInfo.xml` for the "version" and then checks if an equal tag exists on
the GitHub repository for that mod. If both are true, the download url
will be fixed to the specific tag.

##### Note about fallback behavior

When the `ModInfo.xml` mentions a "version" that is not know as a tag, the
download url for the [7D2DModLauncher][1] will be the latest version of the repo.
This is the same as currently all mods are handled, since the SVN download
url doesn't include any version information. Thus it's not 100% predictable
if you got the same source-files even the main version hasn't changed.

##### Developing Workflow with tagged versions

Once you tie your `ModInfo.xml` version to git tags, you can simply add commits
to your master branch, without [7D2DModLauncher][1] picking those changes up.
People who want to use cutting edge versions of your mod will need to use [DMT][1]
directly. They just need to clone your mod repository into their DMT mod folder.
When you have a new version tested and ready to release, simply create a commit
that increments the version in `ModInfo.xml` and tag that commit accordingly.
Then push the new commit with the associated tag to GitHub. Once you're happy
with that version don't forget to update the sub-module in the "big-repo". Once
that reference is updated, the crawler should pick-up the new version for everyone
to enjoy. It might seems like a few obstacles for releasing a new version, but
it's IMO imposing pretty much the right amount of quality gates.

### Further possibilities

One cool thing about these patches is IMO that they didn't need any modification
to the end-user [7D2DModLauncher][1]. I only needed to patch the crawler. With
adding support for downloading tagged versions, this opens up the possibility
to expose this feature to the UI and let end-users choose a specific version.

### Pseudo-Code of patched crawler

- Query entry GitHub url
- Find all submodules in root
  - Fetch `{submodule}:{commitId}:/ModInfo.xml`
  - Parse `version` of `{submodule}:{commitId}:/ModInfo.xml`
  - Check if a `{submodule}:tag` equal to `version` exists
    - If yes, add versions specific SVN download url
    - If not, add SVN download url for master branch

### Addendum: How the crawler crawls GitHub

GitHub entry "urls" are handled via [octokit.net][5] which allows quite elaborate
interaction with GitHub. It is used to query for our submodules and to retrieve
their `ModInfo.xml` files. It also supports to query directories and download files,
which seemed like a way to get rid of the SVN download approach. But it turned out
to be useless, since it has a rather low file size restrictions (so SVN it is).

## Final Words

Thx to [SphereII][6] for letting me hack his crawler to support my preferred git setup!
I hope people see the benefit of doing it this way, which is why I wrote this all up!

[1]: http://7d2dmodlauncher.org/
[2]: https://github.com/7D2DModLauncher/Database
[3]: https://github.com/SphereII/SphereII.ModsA19
[4]: https://github.com/HAL-NINE-THOUSAND/DMT
[5]: https://github.com/octokit/octokit.net
[6]: https://github.com/SphereII
[7]: https://github.blog/2012-06-26-collaborating-on-github-with-subversion/